version: '3'

services:
    db:
        build:
            dockerfile: Dockerfile-postgres
            context: ./postgres
        expose:
            - 5432
    django:
        environment:
          - DATABASE_NAME=tfrs
          - DATABASE_USER=tfrs
          - DATABASE_PASSWORD=development_only
          - DATABASE_ENGINE=postgresql
          - DATABASE_SERVICE_NAME=postgresql
          - POSTGRESQL_SERVICE_HOST=db
          - POSTGRESQL_SERVICE_PORT=5432
          - RABBITMQ_VHOST=/tfrs
          - RABBITMQ_USER=rabbitmq
          - RABBITMQ_PASSWORD=rabbitmq
          - RABBITMQ_HOST=rabbit
          - RABBITMQ_PORT=5672
        depends_on:
            - db
        build:
            dockerfile: Dockerfile-django
            context: ./backend
        command: >
                bash -c
                "/wfi/wait-for-it.sh -t 14400 rabbit:5672 &&
                /wfi/wait-for-it.sh -t 14400 db:5432 &&
                pip install -q -r requirements.txt &&
                python3 manage.py makemigrations &&
                python3 manage.py migrate &&
                python3 manage.py load_ops_data api/fixtures/development/dockerized.py &&
                python3 manage.py runserver 0.0.0.0:8000"
        expose:
            - 8000
        volumes:
            - shared:/shared
            - ./backend:/app
    node:
        build:
            dockerfile: Dockerfile-node
            context: ./frontend
        command: >
                bash -c
                "npm install &&
                /wfi/wait-for-it.sh rabbit:5672 -t 14400 &&
                npm run start:docker"
        depends_on:
            - rabbit
        expose:
            - 3000
        environment:
            - RABBITMQ_VHOST=/tfrs
            - RABBITMQ_USER=rabbitmq
            - RABBITMQ_PASSWORD=rabbitmq
            - RABBITMQ_HOST=rabbit
            - RABBITMQ_PORT=5672
        volumes:
            - ./frontend:/app
            - node_modules:/app/node_modules
    nginx:
        depends_on:
            - django
            - node
        build:
            dockerfile: Dockerfile-nginx
            context: ./nginx
        ports:
            - 5001:10920
            - 5002:10921
            - 5003:10922
            - 5004:10923
            - 5005:10924
            - 5006:10925
            - 5000:10000
        volumes:
            - shared:/shared
        command: >
                bash -c
                "/wfi/wait-for-it.sh -t 14400 django:8000 &&
                /wfi/wait-for-it.sh -t 14400 node:3000 &&
                cat /tfrs/ready.txt &&
                nginx -g \"daemon off;\""
    rabbit:
        image: rabbitmq:3.7-management
        hostname: "rabbit"
        environment:
            - RABBITMQ_DEFAULT_USER=rabbitmq
            - RABBITMQ_DEFAULT_PASS=rabbitmq
            - RABBITMQ_DEFAULT_VHOST=/tfrs
        ports:
            - "15672:15672"
            - "5672:5672"
volumes:
    shared:
    node_modules:
